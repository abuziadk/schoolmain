<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  :root {
    --green-dark:#004d40;
    --green:#00796b;
    --green-grad-start:#a5d6a7;
    --green-grad-end:#1b5e20;
    --gray-grad-start:#f7f7f7;
    --gray-grad-end:#eceff1;
  }
  html,body{margin:0;padding:0;font-family:'Cairo',sans-serif;}
  body{background: linear-gradient(180deg, var(--gray-grad-start), var(--gray-grad-end)); min-height:100vh;}
  .header{
    background: linear-gradient(135deg, var(--green-grad-start), var(--green-grad-end));
    color:#fff; padding:16px 12px;
  }
  .header .wrap{max-width:1100px;margin:0 auto; display:flex; align-items:center; gap:16px;}
  .header img{width:110px; height:auto; object-fit:contain;}
  .title-box{display:flex; flex-direction:column; gap:4px}
  .title-box h1{margin:0;font-size:1.4rem;letter-spacing:.2px}
  .title-box p{margin:0;opacity:.9}
  .navbar{
    position: sticky; top:0; z-index:1000;
    background: rgba(0, 77, 64, 0.95);
    backdrop-filter: saturate(150%) blur(3px);
    box-shadow: 0 2px 8px rgba(0,0,0,.15);
  }
  .nav-wrap{max-width:1100px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center}
  .nav-wrap a{
    color:#fff; text-decoration:none; padding:12px 14px; display:block; font-weight:700; border-radius:8px; transition:.2s;
  }
  .nav-wrap a:hover{background:#00695c}
  .active{background:#00695c}
  main{max-width:1100px;margin:22px auto; background:#fff; padding:24px; border-radius:14px; box-shadow:0 8px 18px rgba(0,0,0,.06)}
  h2{color:#00695c;margin-top:0}
  .footer{
    margin-top:28px; background: var(--green-dark); color:#fff; padding:18px 12px;
  }
  .footer .wrap{max-width:1100px;margin:0 auto; display:grid; gap:10px}
  .quick-links a{color:#fff; text-decoration:none; margin:0 8px}
  .contact-line{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .contact-line a{color:#fff; text-decoration:none; display:inline-flex; align-items:center; gap:6px}
  .contact-line i{font-size:1.1rem}
</style>

<title>الدرجات - مدرسة تحفيظ ضمد الإبتدائية والمتوسطة</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<style>
  .form-row{display:grid; gap:10px; grid-template-columns:1fr auto; align-items:center}
  input[type="text"]{width:107%; padding:12px; border:1px solid #ccc; border-radius:8px; font-size:1rem}
  button.search-btn{padding:14px 25px; background:var(--green); color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:700}
  button.search-btn:hover{background:#00695c}
  #pdfContainer canvas{width:100%; height:auto; border:1px solid #e0e0e0; border-radius:8px}
  .hint{opacity:.85} .status{margin-top:10px; font-weight:700}
</style>
</head>
<body>

<div class="header">
  <div class="wrap">
    <img src="images/bg2.png" alt="شعار المدرسة">
    <div class="title-box">
      <h1>مدرسة تحفيظ ضمد الإبتدائية والمتوسطة</h1>
      <p>بوابتك الإلكترونية لمتابعة كل جديد</p>
    </div>
  </div>
</div>
<nav class="navbar">
  <div class="nav-wrap">
    <a class="" href="index.html">الرئيسية</a>
    <a class="active" href="grades.html">الدرجات</a>
    <a class="" href="about.html">عن المدرسة</a>
    <a class="" href="teachers.html">المعلمين</a>
    <a class="" href="activities.html">الأنشطة</a>
    <a class="" href="gallery.html">معرض الصور</a>
    <a class="" href="contact.html">اتصل بنا</a>
  </div>
</nav>

<main>
  <h2>الاستعلام عن إشعار الدرجات</h2>
  <p class="hint">أدخل السجل المدني المكوّن من 10 أرقام.</p>
  <div class="form-row" dir="rtl">
    <input type="text" id="studentId" placeholder="أدخل رقم الهوية الوطنية">
    <button class="search-btn" onclick="searchCertificate()"><i class="fa fa-search"></i> بحث</button>
  </div>
  <div id="result" class="status"></div>
  <div id="pdfContainer" style="margin-top:16px"></div>
  <button id="downloadBtn" style="display:none; margin-top: 16px; padding:12px 16px; background:#1e88e5; color:#fff; border:none; border-radius:8px; font-weight:700">تحميل الشهادة PDF</button>
</main>

<footer class="footer">
  <div class="wrap">
    <div class="quick-links">
      روابط سريعة:
      <a href="index.html">الرئيسية</a> |
      <a href="grades.html">الدرجات</a> |
      <a href="contact.html">اتصل بنا</a>
    </div>
    <div class="contact-line">
      <span>👨‍💻 البرمجة والتصميم: م. خليل أبوحوزه</span>
      <a href="https://wa.me/966548884252" target="_blank" aria-label="WhatsApp"><i class="fab fa-whatsapp"></i> واتساب</a>
      <a href="https://www.facebook.com/khalil.abuhozah" target="_blank" aria-label="Facebook"><i class="fab fa-facebook"></i> فيسبوك</a>
      <a href="https://x.com/abuhawzah" target="_blank" aria-label="X"><i class="fab fa-x-twitter"></i> X</a>
    </div>
    <div>جميع الحقوق محفوظة &copy; 2024 - مدرسة تحفيظ ضمد الإبتدائية والمتوسطة</div>
  </div>
</footer>

<script>
  let foundPage = null;
  let pdfDoc = null;

  async function searchCertificate() {
    const studentId = document.getElementById('studentId').value.trim();
    const resultDiv = document.getElementById('result');
    const pdfContainer = document.getElementById('pdfContainer');
    const downloadBtn = document.getElementById('downloadBtn');

    pdfContainer.innerHTML = "";
    resultDiv.textContent = "";
    downloadBtn.style.display = "none";

    if (studentId.length !== 10 || isNaN(studentId)) {
      resultDiv.textContent = "رقم الهوية غير صحيح. يجب أن يتكون من 10 أرقام.";
      return;
    }

    resultDiv.textContent = "جاري البحث...";
    const pdfFiles = ['uploads/1.pdf','uploads/2.pdf','uploads/3.pdf','uploads/4.pdf','uploads/5.pdf'];
    let certificateFound = false;

    for (const pdfFile of pdfFiles) {
      try {
        pdfDoc = await pdfjsLib.getDocument(pdfFile).promise;
        for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
          const page = await pdfDoc.getPage(pageNum);
          const textContent = await page.getTextContent();
          const text = textContent.items.map(item => item.str).join(" ");
          if (text.includes(studentId)) {
            displayCertificatePage(page, pdfContainer);
            foundPage = pageNum;
            downloadBtn.style.display = "inline-block";
            certificateFound = true;
            break;
          }
        }
      } catch (e) {
        console.error("PDF load error:", e);
      }
      if (certificateFound) break;
    }

    resultDiv.textContent = certificateFound ? "✅ تم العثور على الشهادة." : "❌ لم يتم العثور على شهادة لهذا الرقم.";
  }

  function displayCertificatePage(page, container) {
    const viewport = page.getViewport({ scale: 1.5 });
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    page.render({ canvasContext: context, viewport: viewport }).promise.then(() => {
      container.appendChild(canvas);
    });
  }

  async function downloadCertificate() {
    if (foundPage && pdfDoc) {
      const pdfBytes = await pdfDoc.getData();
      const existingPdfBytes = new Uint8Array(pdfBytes);
      const pdfDocNew = await PDFLib.PDFDocument.load(existingPdfBytes);
      const newPdf = await PDFLib.PDFDocument.create();
      const [copiedPage] = await newPdf.copyPages(pdfDocNew, [foundPage - 1]);
      newPdf.addPage(copiedPage);
      const newPdfBytes = await newPdf.save();
      const blob = new Blob([newPdfBytes], { type: 'application/pdf' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `الشهادة_${foundPage}.pdf`;
      link.click();
    }
  }
  document.getElementById('downloadBtn').addEventListener('click', downloadCertificate);
</script>
</body>
</html>
